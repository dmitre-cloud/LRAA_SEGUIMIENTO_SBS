{% extends "solicitudes/base.html" %}

{% load humanize %}

{% block title %}Detalle de Solicitud #{{ object.id }}{% endblock %}

{% block content %}
<div class="row g-4">
    {# Columna de Detalles de la Solicitud #}
    <div class="col-lg-5 col-md-12">
        <div class="card shadow-sm">
            <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #003366;">
                <h4 class="mb-0">Detalles de Solicitud #{{ object.id }}</h4>
                <a href="{% url 'solicitud-list' %}" class="btn btn-sm btn-light">
                    <i class="bi bi-arrow-left"></i> Volver al listado
                </a>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5 text-muted">Descripci칩n:</dt>
                    <dd class="col-sm-7 fw-bold">{{ object.descripcion_pedido }}</dd>

                    <dt class="col-sm-5 text-muted">Departamento:</dt>
                    <dd class="col-sm-7">{{ object.get_departamento_display }}</dd>

                    <dt class="col-sm-5 text-muted">Ref. Departamento:</dt>
                    <dd class="col-sm-7">{{ object.ref_departamento|default:"N/A" }}</dd>

                    <dt class="col-sm-5 text-muted">Tipo de Compra:</dt>
                    <dd class="col-sm-7">{{ object.get_tipo_compra_display }}</dd>

                    <dt class="col-sm-5 text-muted">Monto Comprometido:</dt>
                    <dd class="col-sm-7 text-success fw-bold">B/. {{ object.monto_comprometido_sbs|intcomma }}</dd>
                    
                    <dt class="col-sm-5 text-muted">Solicitante:</dt>
                    <dd class="col-sm-7">{{ object.solicitante.get_full_name|default:object.solicitante.username }}</dd>
                </dl>
                <div class="mt-3">
                    <a href="{% url 'solicitud-update' object.pk %}" class="btn btn-warning w-100">
                        <i class="bi bi-pencil-square"></i> Editar Solicitud
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Columna del Formulario de Seguimiento #}
    <div class="col-lg-7 col-md-12 mb-3">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h4 class="mb-0">Gesti칩n de Seguimiento de Compra 游닇</h4>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'seguimiento-update' solicitud_pk=object.pk %}">
                    {% csrf_token %}
                    
                    <div class="row g-3">
                        {% for field in seguimiento_form %}
                            {% if field.field.widget.input_type != 'checkbox' %}
                                
                                {# L칩gica para definir si el campo ocupa 6 columnas (col-md-6) o 12 (col-md-12) #}
                                {% with col_class="col-md-6" %}
                                    {# Campos anchos: Observaciones, Ajustes, Enlaces, Recibo #}
                                    {% if 'observacion' in field.name or field.name == 'solicitud_ajuste' or 'enlace' in field.name or field.name == 'fecha_recibo' or field.name == 'quien_recibe_almacen' %}
                                        {% with col_class="col-md-12" %}{% endwith %}
                                    {% endif %}
                                    
                                    <div class="{{ col_class }}">
                                        <div class="form-group">
                                            
                                            <label for="{{ field.id_for_label }}" class="form-label">
                                                {{ field.label }}
                                                {% if field.name == 'status_final_compra' %}
                                                    <span class="badge bg-info text-dark ms-2">{{ object.get_tipo_compra_display }}</span>
                                                {% endif %}
                                            </label>
                                            
                                            {# L칩gica para campos de enlace #}
                                            {% if 'enlace' in field.name and field.value %}
                                                <div class="input-group">
                                                    {{ field }}
                                                    <a href="{{ field.value }}" target="_blank" class="btn btn-primary" title="Abrir Enlace">
                                                        <i class="bi bi-box-arrow-up-right"></i> Abrir Enlace </a>
                                                </div>
                                            {% else %}
                                                {{ field }}
                                            {% endif %}

                                            {# Mensajes de ayuda y errores #}
                                            {% for error in field.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div> 
                                            {% endfor %}
                                            {% if field.help_text %}
                                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                            {% endif %}
                                        </div>
                                    </div> 
                                {% endwith %}
                            {% endif %}
                            
                            {% if field.name == 'observacion_2' %}
                                <div class="col-md-12">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="form-check pt-4">
                                                {{ seguimiento_form.calibracion }}
                                                <label class="form-check-label" for="{{ seguimiento_form.calibracion.id_for_label }}">
                                                    {{ seguimiento_form.calibracion.label }}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check pt-4">
                                                {{ seguimiento_form.mantenimiento }}
                                                <label class="form-check-label" for="{{ seguimiento_form.mantenimiento.id_for_label }}">
                                                    {{ seguimiento_form.mantenimiento.label }}
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check pt-4">
                                                {{ seguimiento_form.caracterizacion }}
                                                <label class="form-check-label" for="{{ seguimiento_form.caracterizacion.id_for_label }}">
                                                    {{ seguimiento_form.caracterizacion.label }}
                                                </label>
                                            </div>
                                        </div>
                                        {% if seguimiento_form.calibracion.errors or seguimiento_form.mantenimiento.errors or seguimiento_form.caracterizacion.errors %}
                                            <div class="col-md-12">
                                                {% for error in seguimiento_form.calibracion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                                                {% for error in seguimiento_form.mantenimiento.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                                                {% for error in seguimiento_form.caracterizacion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                            {% endfor %}
                    </div>
                    
                    <div class="mt-4">
                        {% if user.job_position == 'Asistente Administrativo' or user.job_position == 'Director Encargado' %}
                            
                            <button type="submit" class="btn btn-success btn-lg w-100 shadow-sm">
                                <i class="bi bi-save"></i> Guardar Seguimiento
                            </button>

                        {% else %}

                            <button type="submit" class="btn btn-secondary btn-lg w-100" disabled>
                                <i class="bi bi-lock"></i> Guardar Seguimiento (Acceso Restringido)
                            </button>
                            <small class="form-text text-danger text-center d-block mt-2">
                                Solo el personal administrativo autorizado puede editar esta secci칩n.
                            </small>

                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // 1. Selecciona los CUATRO campos del formulario que usaremos.
    const fechaPublicacionInput = document.getElementById('id_fecha_publicacion_oc');
    const plazoEntregaInput = document.getElementById('id_plazo_entrega');
    const vencimientoInput = document.getElementById('id_vencimiento_oc');
    // --- NUEVO: Selector para el tipo de plazo. AJUSTA EL ID SI ES NECESARIO ---
    const tipoPlazoInput = document.getElementById('id_tipo_plazo_entrega'); 

    // Funci칩n para a침adir d칤as H츼BILES a una fecha (lunes a viernes).
    function agregarDiasHabiles(fechaInicial, dias) {
        if (dias <= 0) return new Date(fechaInicial.valueOf());
        
        let fecha = new Date(fechaInicial.valueOf());
        let diasAgregados = 0;

        while (diasAgregados < dias) {
            fecha.setDate(fecha.getDate() + 1);
            // getDay() devuelve 0 (Domingo) y 6 (S치bado).
            if (fecha.getDay() !== 0 && fecha.getDay() !== 6) {
                diasAgregados++;
            }
        }
        return fecha;
    }

    // --- NUEVA FUNCI칍N: Para a침adir d칤as CALENDARIO (corridos).
    function agregarDiasCalendario(fechaInicial, dias) {
        if (dias < 0) dias = 0;
        let fecha = new Date(fechaInicial.valueOf());
        fecha.setDate(fecha.getDate() + dias);
        return fecha;
    }


    // 2. La funci칩n principal que se ejecutar치 cada vez que cambie un valor.
    function calcularFechaVencimiento() {
        // Obtiene los valores actuales de los campos
        const fechaPublicacionValor = fechaPublicacionInput.value;
        const plazoEntregaValor = parseInt(plazoEntregaInput.value, 10);
        const tipoPlazoValor = tipoPlazoInput.value; // 'Habiles' o 'Calendario'

        // --- Verificaci칩n mejorada ---
        if (!fechaPublicacionValor || isNaN(plazoEntregaValor) || plazoEntregaValor < 0 || !tipoPlazoValor) {
            vencimientoInput.value = '';
            return;
        }

        // --- L칩gica de C치lculo Condicional ---
        const fechaBase = new Date(fechaPublicacionValor + 'T00:00:00');
        let fechaFinal;

        // Siempre se suman 2 d칤as h치biles como base, seg칰n tu requerimiento.
        const fechaConDiasBase = agregarDiasHabiles(fechaBase, 2);

        if (tipoPlazoValor === 'Habiles') {
            // Si es 'Habiles', sumamos el plazo tambi칠n como d칤as h치biles.
            fechaFinal = agregarDiasHabiles(fechaConDiasBase, plazoEntregaValor);
        } else if (tipoPlazoValor === 'Calendario') {
            // Si es 'Calendario', sumamos el plazo como d칤as corridos.
            fechaFinal = agregarDiasCalendario(fechaConDiasBase, plazoEntregaValor);
        } else {
            vencimientoInput.value = '';
            return;
        }
        
        // --- Formateo y Asignaci칩n (sin cambios) ---
        const anio = fechaFinal.getFullYear();
        const mes = String(fechaFinal.getMonth() + 1).padStart(2, '0');
        const dia = String(fechaFinal.getDate()).padStart(2, '0');
        
        const fechaFormateada = `${anio}-${mes}-${dia}`;
        vencimientoInput.value = fechaFormateada;
    }

    // 3. Asigna los "event listeners" (escuchadores).
    fechaPublicacionInput.addEventListener('change', calcularFechaVencimiento);
    plazoEntregaInput.addEventListener('input', calcularFechaVencimiento);
    // --- NUEVO: Escuchador para el cambio de tipo de plazo ---
    tipoPlazoInput.addEventListener('change', calcularFechaVencimiento);


    // 4. Llama a la funci칩n una vez al cargar la p치gina para calcular el valor inicial si lo hay.
    calcularFechaVencimiento();

});
</script>
{% endblock %}